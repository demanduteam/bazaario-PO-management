<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Purchase Order Management</title>
    
    <!-- Core Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        vazir: ['Vazirmatn', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        body {
            font-family: 'Vazirmatn', 'sans-serif';
            background-color: #f3f4f6;
        }
        .dark body {
            background-color: #111827;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 95%;
            max-width: 950px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-options {
                display: none;
            }
            #printable-po, #printable-po * {
                visibility: visible;
            }
            #printable-po {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                border: none;
                color: black;
                background: white;
            }
        }
    </style>
</head>
<body class="dark transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        // ==================================================
        // Supabase Client Setup
        // ==================================================
        const { createClient } = supabase;
        const supabaseUrl = 'https://wehyjatotbzxargnxasg.supabase.co';
        // Note: In a real production environment, ensure this key is secured or use RLS policies.
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlaHlqYXRvdGJ6eGFyZ254YXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTIwMjEsImV4cCI6MjA2NzQ4ODAyMX0.2R448DuEBlTrNvaYXiYZ8D5M7MJNv7n1qmIDHQBNFiY';
        
        const supabaseClient = createClient(supabaseUrl, supabaseKey, { 
            global: { 
                fetch: window.fetch.bind(window) 
            } 
        });

        // ==================================================
        // Helper Functions & Constants
        // ==================================================
        const formatCurrency = (value) => {
            if (value === null || typeof value === 'undefined' || isNaN(value)) return '۰';
            return `${Number(value).toLocaleString('fa-IR')}`;
        };

        const formatNumberWithCommas = (value) => {
            if (value === null || value === undefined || value === '' || isNaN(Number(value))) return '';
            const stringValue = String(value).replace(/,/g, '');
            const numberValue = Number(stringValue);
            if (isNaN(numberValue)) return '';
            return numberValue.toLocaleString('en-US');
        };

        const parseFormattedNumber = (value) => {
            if (typeof value !== 'string' && typeof value !== 'number') return 0;
            if(typeof value === 'number') return value;
            return Number(String(value).replace(/,/g, '')) || 0;
        };

        // Reuse fetchUserBalance logic from Invoice Management
        const fetchUserBalance = async (userId) => {
            if (!userId) return 0;
            try {
                // 1. Get Total Payments (Credits)
                const { data: transactions, error: txError } = await supabaseClient
                    .from('usertransaction')
                    .select('amount')
                    .eq('userid', userId);
                
                if (txError) throw txError;
                const totalPaid = transactions.reduce((sum, tx) => sum + (tx.amount || 0), 0);

                // 2. Get Total Invoiced Amount (Debits)
                const { data: invoices, error: invError } = await supabaseClient
                    .from('demandinvoice')
                    .select('totalamount')
                    .eq('customeruserid', userId);

                if (invError) throw invError;
                const totalInvoiced = invoices.reduce((sum, inv) => sum + (inv.totalamount || 0), 0);
                
                // 3. Calculate Balance: (Money In) - (Money Owed)
                return totalPaid - totalInvoiced;
            } catch (err) {
                console.error('Exception fetching balance:', err);
                return 0;
            }
        };
        
        const PO_STATUSES = ['باید بخرم', 'خریداری شد', 'تحویل بازوی ارسال شد', 'تحویل مشتری شد', 'محاسبه سود و زیان انجام شد', 'Cancelled', 'Merged'];
        const MY_COMPANY_PROFILE_ID = 'f83dca6b-9bc3-4bc2-8ac0-609a4147269b';

        const getStatusStyles = (status) => {
            switch (status) {
                case 'باید بخرم': return 'bg-yellow-100 dark:bg-yellow-900/40 text-yellow-800 dark:text-yellow-200 border-yellow-300 dark:border-yellow-700';
                case 'خریداری شد': return 'bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 border-blue-300 dark:border-blue-700';
                case 'تحویل بازوی ارسال شد': return 'bg-purple-100 dark:bg-purple-900/40 text-purple-800 dark:text-purple-200 border-purple-300 dark:border-purple-700';
                case 'تحویل مشتری شد': return 'bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200 border-green-300 dark:border-green-700';
                case 'محاسبه سود و زیان انجام شد': return 'bg-teal-100 dark:bg-teal-900/40 text-teal-800 dark:text-teal-200 border-teal-300 dark:border-teal-700';
                case 'Cancelled': return 'bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-200 border-red-300 dark:border-red-700';
                case 'Merged': return 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border-gray-400 dark:border-gray-600';
                default: return 'bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600';
            }
        };

        const getDemandStatusStyles = (status) => {
            switch (status) {
                case 'Pending': return 'bg-yellow-100 dark:bg-yellow-900/40 text-yellow-800 dark:text-yellow-200 border border-yellow-300 dark:border-yellow-700';
                case 'In Progress': return 'bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 border border-blue-300 dark:border-blue-700';
                case 'Completed': return 'bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200 border border-green-300 dark:border-green-700';
                case 'Cancelled': return 'bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-200 border border-red-300 dark:border-red-700';
                default: return 'bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300';
            }
        };

        // ==================================================
        // Toast Notification System
        // ==================================================
        const ToastContext = React.createContext();

        const ToastProvider = ({ children }) => {
            const [toast, setToast] = React.useState(null);

            const showToast = (message, type = 'success') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 4000);
            };

            return (
                <ToastContext.Provider value={showToast}>
                    {children}
                    {toast && (
                        <div className={`fixed bottom-5 left-5 p-4 rounded-lg shadow-xl text-white text-sm font-semibold z-[200] transform transition-all duration-300 flex items-center gap-2 ${toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
                            {toast.type === 'success' ? (
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg>
                            ) : (
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            )}
                            {toast.message}
                        </div>
                    )}
                </ToastContext.Provider>
            );
        };

        const useToast = () => React.useContext(ToastContext);


        // ==================================================
        // UI Components
        // ==================================================
        const Modal = ({ isOpen, onClose, title, children, showHeader = true }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 animate-fade-in" onClick={e => e.stopPropagation()}>
                        {showHeader && (
                            <div className="flex justify-between items-center mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                                <h2 className="text-xl font-bold text-gray-800 dark:text-white">{title}</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-800 dark:hover:text-white transition-colors text-2xl">&times;</button>
                            </div>
                        )}
                        {children}
                    </div>
                </div>
            );
        };

        const SearchableDropdown = ({ options, value, onChange, placeholder = "Search..." }) => {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [isOpen, setIsOpen] = React.useState(false);
            const wrapperRef = React.useRef(null);

            const selectedOption = React.useMemo(() => options.find(option => option.id === value), [options, value]);

            React.useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                        if (selectedOption) {
                           setSearchTerm(selectedOption.fullname);
                        }
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [wrapperRef, selectedOption]);

            const filteredOptions = React.useMemo(() => 
                options.filter(option =>
                    option.fullname.toLowerCase().includes(searchTerm.toLowerCase())
                ), [options, searchTerm]);

            const handleSelect = (optionId) => {
                onChange(optionId);
                setIsOpen(false);
                const selected = options.find(o => o.id === optionId);
                setSearchTerm(selected ? selected.fullname : '');
            };
            
            const handleInputChange = (e) => {
                setSearchTerm(e.target.value);
                if (!isOpen) setIsOpen(true);
            };
            
            const handleInputFocus = () => {
                setIsOpen(true);
                setSearchTerm('');
            };

            const handleInputBlur = () => {
                setTimeout(() => {
                    if (selectedOption) {
                        setSearchTerm(selectedOption.fullname);
                    }
                    setIsOpen(false);
                }, 150);
            };

            return (
                <div className="relative" ref={wrapperRef}>
                    <input
                        type="text"
                        value={isOpen ? searchTerm : (selectedOption?.fullname || '')}
                        onChange={handleInputChange}
                        onFocus={handleInputFocus}
                        // onBlur={handleInputBlur} // Disabling blur logic to prevent conflicts with click event on dropdown options
                        placeholder={placeholder}
                        className="w-full bg-gray-50 dark:bg-gray-700 p-2.5 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    />
                    {isOpen && (
                        <ul className="absolute z-20 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-xl">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map(option => (
                                    <li
                                        key={option.id}
                                        onMouseDown={() => handleSelect(option.id)}
                                        className="p-2.5 hover:bg-indigo-50 dark:hover:bg-indigo-900/50 hover:text-indigo-700 dark:hover:text-indigo-300 cursor-pointer transition-colors border-b dark:border-gray-700 last:border-0"
                                    >
                                        {option.fullname}
                                    </li>
                                ))
                            ) : (
                                <li className="p-3 text-gray-500 text-center text-sm">موردی یافت نشد.</li>
                            )}
                        </ul>
                    )}
                </div>
            );
        };


        const ViewPOModal = ({ po, onClose, customerBalance }) => {
            if (!po) return null;
            return (
                <Modal isOpen={!!po} onClose={onClose} title={`جزئیات سفارش خرید #${po.id}`}>
                    <div className="space-y-6">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-6 text-sm bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                            <div><span className="text-gray-500 dark:text-gray-400">تامین کننده:</span> <span className="font-semibold block text-base">{po.supplier?.fullname || 'نامشخص'}</span></div>
                            <div><span className="text-gray-500 dark:text-gray-400">تاریخ ایجاد:</span> <span className="font-semibold block text-base">{new Date(po.created_at).toLocaleDateString('fa-IR')}</span></div>
                            <div><span className="text-gray-500 dark:text-gray-400">فاکتور مشتری:</span> <span className="font-mono block">#{po.realInvoiceId || '---'}</span></div>
                            <div><span className="text-gray-500 dark:text-gray-400">شماره درخواست:</span> <span className="font-mono block">#{po.demandid || '---'}</span></div>
                            <div className="sm:col-span-2">
                                <span className="text-gray-500 dark:text-gray-400">مشتری:</span> 
                                <span className="font-semibold block text-base">{po.demand?.customer?.fullname || 'نامشخص'}</span>
                                {typeof customerBalance === 'number' && (
                                    <span className={`block mt-1 text-xs ${customerBalance < 0 ? 'text-red-500' : 'text-green-500'}`}>
                                        مانده حساب: {formatCurrency(customerBalance)} تومان
                                    </span>
                                )}
                            </div>
                        </div>
                        
                        <div>
                            <h3 className="text-lg font-bold mb-3 border-b dark:border-gray-700 pb-2">اقلام سفارش</h3>
                            <div className="overflow-x-auto rounded-lg border dark:border-gray-700">
                                <table className="w-full text-right text-sm">
                                    <thead className="bg-gray-100 dark:bg-gray-700">
                                        <tr>
                                            <th className="p-3 font-semibold">محصول</th>
                                            <th className="p-3 font-semibold text-center text-gray-500">تعداد درخواستی مشتری</th>
                                            <th className="p-3 font-semibold text-center">تعداد خرید</th>
                                            <th className="p-3 font-semibold text-center text-gray-500">شناسه جزئیات فاکتور</th>
                                            <th className="p-3 font-semibold">قیمت خرید</th>
                                            <th className="p-3 font-semibold text-indigo-600 dark:text-indigo-400">هزینه حمل واحد (واقعی)</th>
                                            <th className="p-3 font-semibold">جمع کل خرید</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                                        {po.purchase_order_details.map(detail => {
                                            const lineTotal = detail.quantity * detail.purchase_price;
                                            return (
                                                <tr key={detail.id} className="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                                    <td className="p-3">{detail.demand_item?.product?.title || 'محصول نامشخص'}</td>
                                                    <td className="p-3 text-center text-gray-500 dark:text-gray-400 bg-gray-50/50 dark:bg-gray-800/50">
                                                        {detail.customerRequestedQty || '-'}
                                                    </td>
                                                    <td className="p-3 text-center font-medium">{detail.quantity}</td>
                                                    <td className="p-3 text-center font-mono text-xs text-gray-500">
                                                        {detail.invDetailId ? `#${detail.invDetailId}` : '-'}
                                                        {detail.invDetailShipping > 0 && <span className="block text-[10px] text-green-600">هزینه حمل: {formatCurrency(detail.invDetailShipping)}</span>}
                                                    </td>
                                                    <td className="p-3 text-gray-600 dark:text-gray-300">{formatCurrency(detail.purchase_price)}</td>
                                                    <td className="p-3 text-indigo-600 dark:text-indigo-400 font-medium">
                                                        {formatCurrency(detail.actual_shipping_price || 0)}
                                                    </td>
                                                    <td className="p-3 font-medium">{formatCurrency(lineTotal)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg space-y-2">
                            <div className="flex justify-between text-sm">
                                <span>جمع محصولات:</span>
                                <span>{formatCurrency(po.subtotal)} تومان</span>
                            </div>
                            <div className="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                                <span>هزینه حمل مشتری (مجموع اقلام):</span>
                                <span>{formatCurrency(po.customerShippingCost)} تومان</span>
                            </div>
                            <div className="flex justify-between text-sm font-medium text-gray-800 dark:text-gray-200">
                                <span>هزینه حمل واقعی (پرداختی ما - کل):</span>
                                <span>{formatCurrency(po.actual_shipping_cost || 0)} تومان</span>
                            </div>
                            <div className="flex justify-between font-bold text-lg text-indigo-700 dark:text-indigo-300 pt-2 border-t border-indigo-200 dark:border-indigo-800">
                                <span>مبلغ فاکتور تامین کننده:</span>
                                <span>{formatCurrency(po.subtotal)} تومان</span>
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        };

        const EditPOModal = ({ po, onClose, onSave, customerBalance }) => {
            const [details, setDetails] = React.useState(JSON.parse(JSON.stringify(po.purchase_order_details)));
            const [isSaving, setIsSaving] = React.useState(false);
            const [suppliersList, setSuppliersList] = React.useState([]);
            const [selectedSupplierId, setSelectedSupplierId] = React.useState(po.supplier_id);
            const showToast = useToast();

             React.useEffect(() => {
                 const fetchSuppliers = async () => {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('id, fullname, firstname') 
                        .eq('roleid', 3);
                        
                    if (error) {
                        console.error('Error fetching suppliers:', error);
                        showToast('خطا در دریافت لیست تامین کنندگان', 'error');
                    } else {
                        // Map data to combine firstname and fullname
                        const formattedSuppliers = data.map(s => ({
                            id: s.id,
                            fullname: s.firstname ? `${s.firstname} ${s.fullname}` : s.fullname
                        }));
                        setSuppliersList(formattedSuppliers);
                    }
                };
                fetchSuppliers();
            }, [showToast]);

            const handleDetailChange = (index, field, value) => {
                const newDetails = [...details];
                
                // Format input value for display, but store the parsed number
                const parsedValue = parseFormattedNumber(value);
                
                newDetails[index][field] = parsedValue;
                setDetails(newDetails);
            };

            const handleBatchShippingChange = (index, totalBatchValue) => {
                const newDetails = [...details];
                const qty = parseFormattedNumber(newDetails[index].quantity);
                const parsedTotalBatchValue = parseFormattedNumber(totalBatchValue);
                if (qty && qty > 0) {
                    // Calculate unit shipping cost from total batch value
                    const unitShippingCost = parsedTotalBatchValue / qty;
                    newDetails[index].actual_shipping_price = unitShippingCost;
                    setDetails(newDetails);
                } else {
                     newDetails[index].actual_shipping_price = 0;
                     setDetails(newDetails);
                }
            };

            const subtotal = details.reduce((sum, d) => sum + (parseFormattedNumber(d.quantity) * parseFormattedNumber(d.purchase_price)), 0);
            const totalRowShipping = details.reduce((sum, d) => sum + (parseFormattedNumber(d.quantity) * parseFormattedNumber(d.actual_shipping_price || 0)), 0);
            // Total amount is JUST subtotal (Supplier PO price)
            const totalAmount = subtotal;

            const handleSave = async () => {
                setIsSaving(true);
                try {
                    // Automatically using totalRowShipping as the actual_shipping_cost for the PO
                    await onSave(po.id, details, totalRowShipping, selectedSupplierId);
                } catch (error) {
                    showToast(`خطا در ذخیره سازی: ${error.message}`, 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <Modal isOpen={!!po} onClose={onClose} title={`ویرایش سفارش خرید #${po.id}`}>
                    <div className="space-y-6">
                             <div className="p-4 bg-gray-50 dark:bg-gray-700/30 rounded-lg space-y-3">
                                <div>
                                    <label className="font-semibold text-sm mb-2 block">تامین کننده:</label>
                                    <SearchableDropdown
                                        options={suppliersList}
                                        value={selectedSupplierId}
                                        onChange={setSelectedSupplierId}
                                        placeholder="جستجو و انتخاب تامین کننده..."
                                    />
                                </div>
                                 {typeof customerBalance === 'number' && (
                                     <div className="text-sm border-t border-gray-200 dark:border-gray-600 pt-2">
                                         <span className="text-gray-500 dark:text-gray-400">مشتری: </span>
                                         <span className="font-medium">{po.demand?.customer?.fullname}</span>
                                         <span className="mx-2">|</span>
                                         <span className="text-gray-500 dark:text-gray-400">مانده حساب: </span>
                                         <span className={`font-bold ${customerBalance < 0 ? 'text-red-500' : 'text-green-500'}`}>{formatCurrency(customerBalance)} تومان</span>
                                     </div>
                                 )}
                             </div>
                        <div className="overflow-x-auto rounded-lg border dark:border-gray-700">
                            <table className="w-full text-right text-sm">
                                <thead className="bg-gray-100 dark:bg-gray-700">
                                    <tr>
                                        <th className="p-3">محصول</th>
                                        <th className="p-3 w-24 text-center">تعداد</th>
                                        <th className="p-3 w-36">قیمت خرید</th>
                                        <th className="p-3 w-40 text-blue-700 dark:text-blue-300">هزینه حمل کل (بچ)</th>
                                        <th className="p-3 w-36 text-indigo-700 dark:text-indigo-300">هزینه حمل واحد (واقعی)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                                    {details.map((detail, index) => (
                                        <tr key={detail.id}>
                                            <td className="p-3 text-gray-700 dark:text-gray-300">{detail.demand_item?.product?.title || 'محصول نامشخص'}</td>
                                            <td className="p-3">
                                                <input 
                                                    type="number" 
                                                    value={detail.quantity} 
                                                    onChange={(e) => handleDetailChange(index, 'quantity', e.target.value)} 
                                                    className="w-full bg-white dark:bg-gray-800 border border-indigo-300 dark:border-indigo-700 p-2 rounded-md text-center font-bold focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm"
                                                />
                                            </td>
                                            <td className="p-3">
                                                <input 
                                                    type="text" 
                                                    value={formatNumberWithCommas(detail.purchase_price)} 
                                                    onChange={(e) => handleDetailChange(index, 'purchase_price', e.target.value)} 
                                                    className="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 p-2 rounded-md text-center focus:ring-2 focus:ring-indigo-500 outline-none"
                                                    dir="ltr"
                                                />
                                            </td>
                                            <td className="p-3">
                                                {/* This input represents the total batch shipping cost (calculated from actual_shipping_price * quantity)
                                                    and is used to set the unit actual_shipping_price. */}
                                                <input 
                                                    type="text" 
                                                    value={formatNumberWithCommas((detail.actual_shipping_price || 0) * (detail.quantity || 0))} 
                                                    onChange={(e) => handleBatchShippingChange(index, e.target.value)} 
                                                    className="w-full bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 p-2 rounded-md text-center focus:ring-2 focus:ring-blue-500 outline-none font-medium"
                                                    placeholder="0"
                                                    dir="ltr"
                                                />
                                            </td>
                                            <td className="p-3">
                                                {/* This input represents the unit actual shipping cost paid by US (actual_shipping_price)
                                                    This value is ONLY saved to purchase_order_details.actual_shipping_price.
                                                    It is NOT synchronized to demandinvoicedetail.shippingprice anymore. */}
                                                <input 
                                                    type="text" 
                                                    value={formatNumberWithCommas(Math.round(detail.actual_shipping_price || 0))} 
                                                    onChange={(e) => handleDetailChange(index, 'actual_shipping_price', e.target.value)} 
                                                    className="w-full bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-200 dark:border-indigo-700 p-2 rounded-md text-center focus:ring-2 focus:ring-indigo-500 outline-none"
                                                    placeholder="0"
                                                    dir="ltr"
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        
                        {/* Summary & Reconciliation */}
                        <div className="grid grid-cols-1 gap-4">
                            <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg flex flex-col justify-center border border-indigo-100 dark:border-indigo-800/50">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-sm text-indigo-800 dark:text-indigo-300">مجموع هزینه حمل کل (واقعی):</span>
                                    <span className="font-mono font-semibold">{formatCurrency(totalRowShipping)}</span>
                                </div>
                                <div className="h-px bg-indigo-200 dark:bg-indigo-700 my-2"></div>
                                <div className="flex justify-between items-center">
                                    <span className="text-indigo-800 dark:text-indigo-200 font-bold">مبلغ فاکتور تامین کننده:</span>
                                    <span className="text-xl font-bold text-indigo-700 dark:text-indigo-300">{formatCurrency(totalAmount)} تومان</span>
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button onClick={onClose} className="px-5 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">انصراف</button>
                            <button onClick={handleSave} disabled={isSaving} className="px-5 py-2.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white shadow-md disabled:bg-indigo-400 disabled:cursor-not-allowed transition-all flex items-center gap-2">
                                {isSaving && <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>}
                                {isSaving ? 'در حال ذخیره...' : 'ذخیره تغییرات'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const PrintablePOModal = ({ po, onClose }) => {
            const [myCompanyProfile, setMyCompanyProfile] = React.useState(null);

            React.useEffect(() => {
                const fetchCompanyProfile = async () => {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('fullname, national_id, mobile, location:locationid(postalcode, address, plaque)')
                        .eq('id', MY_COMPANY_PROFILE_ID)
                        .single();
                    if (error) console.error("Error fetching company profile:", error);
                    else setMyCompanyProfile(data);
                };
                fetchCompanyProfile();
            }, []);

            if (!po) return null;

            return (
                <Modal isOpen={!!po} onClose={onClose} showHeader={false}>
                    <>
                        <div id="printable-po" className="bg-white text-black p-8 font-vazir min-h-[297mm]">
                            <header className="flex justify-between items-start pb-6 border-b-2 border-gray-800 mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold mb-2">سفارش خرید (Purchase Order)</h1>
                                    <div className="text-sm space-y-1">
                                        <p>شماره سفارش: <span className="font-mono font-bold text-lg">{po.id}</span></p>
                                        <p>تاریخ: {new Date(po.created_at).toLocaleDateString('fa-IR')}</p>
                                    </div>
                                </div>
                                <div className="text-left">
                                    <h2 className="text-xl font-bold text-gray-600">{myCompanyProfile?.fullname || 'شرکت ما'}</h2>
                                </div>
                            </header>
                            <section className="grid grid-cols-2 gap-12 mb-8 text-sm">
                                <div className="border p-4 rounded-lg">
                                    <h2 className="font-bold text-base mb-3 border-b pb-2 bg-gray-50 -mx-4 -mt-4 px-4 py-2 rounded-t-lg">مشخصات فروشنده (تامین کننده)</h2>
                                    <div className="space-y-2">
                                        <p><span className="font-semibold w-24 inline-block">نام:</span> {po.supplier?.fullname || '...'}</p>
                                        <p><span className="font-semibold w-24 inline-block">شماره تماس:</span> {po.supplier?.mobile || '--'}</p>
                                        <p><span className="font-semibold w-24 inline-block">آدرس:</span> {`${po.supplier?.location?.address || '--'} ${po.supplier?.location?.plaque ? `پلاک ${po.supplier.location.plaque}` : ''}`.trim()}</p>
                                        <p><span className="font-semibold w-24 inline-block">کدپستی:</span> {po.supplier?.location?.postalcode || '--'}</p>
                                    </div>
                                </div>
                            <div className="border p-4 rounded-lg">
                                    <h2 className="font-bold text-base mb-3 border-b pb-2 bg-gray-50 -mx-4 -mt-4 px-4 py-2 rounded-t-lg">مشخصات خریدار</h2>
                                    <div className="space-y-2">
                                        <p><span className="font-semibold w-24 inline-block">نام:</span> {myCompanyProfile?.fullname || '...'}</p>
                                        <p><span className="font-semibold w-24 inline-block">کد اقتصادی:</span> {myCompanyProfile?.national_id || '--'}</p>
                                        <p><span className="font-semibold w-24 inline-block">شماره تماس:</span> {myCompanyProfile?.mobile || '--'}</p>
                                        <p><span className="font-semibold w-24 inline-block">آدرس:</span> {`${myCompanyProfile?.location?.address || '--'} ${myCompanyProfile?.location?.plaque ? `پلاک ${myCompanyProfile.location.plaque}` : ''}`.trim()}</p>
                                    </div>
                                </div>
                            </section>
                            <section className="mb-8">
                                <table className="w-full text-right text-sm border-collapse border border-gray-300">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="p-3 border border-gray-300 font-bold w-12 text-center">#</th>
                                            <th className="p-3 border border-gray-300 font-bold">شرح محصول</th>
                                            <th className="p-3 border border-gray-300 font-bold w-24 text-center">تعداد</th>
                                            <th className="p-3 border border-gray-300 font-bold w-32">قیمت واحد (تومان)</th>
                                            <th className="p-3 border border-gray-300 font-bold w-32">هزینه حمل واحد</th>
                                            <th className="p-3 border border-gray-300 font-bold w-40">جمع کل (تومان)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {po.purchase_order_details.map((detail, index) => (
                                            <tr key={detail.id}>
                                                <td className="p-3 border border-gray-300 text-center">{index + 1}</td>
                                                <td className="p-3 border border-gray-300">{detail.demand_item?.product?.title || 'محصول نامشخص'}</td>
                                                <td className="p-3 border border-gray-300 text-center">{detail.quantity}</td>
                                                <td className="p-3 border border-gray-300">{formatCurrency(detail.purchase_price)}</td>
                                                <td className="p-3 border border-gray-300">{formatCurrency(detail.actual_shipping_price || 0)}</td>
                                                <td className="p-3 border border-gray-300 font-medium">{formatCurrency(detail.quantity * detail.purchase_price)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </section>
                            <footer>
                                <div className="flex justify-end">
                                    <div className="text-left space-y-2 text-sm w-1/2 max-w-xs border p-4 rounded-lg bg-gray-50">
                                        <div className="flex justify-between gap-4">
                                            <span>جمع محصولات:</span>
                                            <span>{formatCurrency(po.subtotal)}</span>
                                        </div>
                                        <div className="flex justify-between gap-4">
                                            <span>هزینه حمل واقعی (کل):</span>
                                            <span>{formatCurrency(po.actual_shipping_cost || 0)}</span>
                                        </div>
                                        <div className="flex justify-between gap-4 font-bold text-lg border-t border-gray-300 pt-3 mt-2">
                                            <span>مبلغ فاکتور تامین کننده:</span>
                                            <span>{formatCurrency(po.subtotal)} تومان</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-12 flex justify-between px-8 text-sm text-gray-500">
                                    <div>مهر و امضای فروشنده</div>
                                    <div>مهر و امضای خریدار</div>
                                </div>
                            </footer>
                        </div>
                        <div className="flex justify-end gap-4 mt-6 print-options border-t dark:border-gray-700 pt-4">
                            <button onClick={onClose} className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 py-2.5 px-6 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">بستن</button>
                            <button onClick={() => window.print()} className="bg-indigo-600 text-white py-2.5 px-6 rounded-lg hover:bg-indigo-700 shadow-md flex items-center gap-2 transition-colors">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                چاپ سفارش
                            </button>
                        </div>
                    </>
                </Modal>
            );
        };
        
        const MergeConfirmationModal = ({ mergeInfo, onConfirm, onCancel, isMerging }) => {
            if (!mergeInfo.possible) return null;
            
            return (
                <Modal isOpen={true} onClose={onCancel} title="تایید ادغام سفارشات">
                    <div className="space-y-4">
                        <p className="text-gray-700 dark:text-gray-300">
                            شما در حال ادغام <span className="font-bold text-indigo-600 dark:text-indigo-400">{mergeInfo.count}</span> سفارش خرید برای تامین کننده
                            <span className="font-bold text-indigo-600 dark:text-indigo-400 mx-1">{mergeInfo.supplierName}</span> به یک سفارش جدید هستید.
                        </p>
                        <div className="bg-yellow-50 dark:bg-yellow-900/20 border-r-4 border-yellow-500 p-4 rounded-md">
                            <div className="flex">
                                <div className="flex-shrink-0">
                                    <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd"/></svg>
                                </div>
                                <div className="mr-3">
                                    <p className="text-sm text-yellow-700 dark:text-yellow-200">
                                        پس از تایید، سفارشات اصلی به وضعیت 'Merged' تغییر کرده و دیگر قابل ویرایش نخواهند بود. این عملیات غیرقابل بازگشت است.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <p className="font-medium">آیا از ادامه کار اطمینان دارید؟</p>
                        <div className="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button onClick={onCancel} disabled={isMerging} className="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">انصراف</button>
                            <button onClick={onConfirm} disabled={isMerging} className="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white shadow-md disabled:opacity-50 flex items-center gap-2">
                                {isMerging && <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>}
                                {isMerging ? 'در حال ادغام...' : 'بله، ادغام کن'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const StatusConfirmationModal = ({ updateInfo, onConfirm, onCancel, isUpdating }) => {
            if (!updateInfo) return null;

            const { oldStatus, newStatus } = updateInfo;

            return (
                <Modal isOpen={!!updateInfo} onClose={onCancel} title="تایید تغییر وضعیت">
                    <div className="space-y-6">
                        <p className="text-gray-700 dark:text-gray-300">
                            آیا از تغییر وضعیت سفارش
                            <span className="font-bold mx-1 font-mono text-indigo-600 dark:text-indigo-400">#{updateInfo.poId}</span>
                            اطمینان دارید؟
                        </p>
                        <div className="flex items-center justify-center gap-4 text-center p-4 bg-gray-50 dark:bg-gray-700/30 rounded-lg">
                            <span className={`px-4 py-2 text-sm font-semibold rounded-lg border ${getStatusStyles(oldStatus)}`}>
                                {oldStatus}
                            </span>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-400 rtl:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" />
                            </svg>
                            <span className={`px-4 py-2 text-sm font-semibold rounded-lg border ${getStatusStyles(newStatus)}`}>
                                {newStatus}
                            </span>
                        </div>
                        {newStatus === 'Cancelled' && (
                            <div className="bg-red-50 dark:bg-red-900/20 border-r-4 border-red-500 p-4 rounded-md">
                                <p className="text-sm text-red-700 dark:text-red-300">
                                    <span className="font-bold">هشدار:</span> کنسل کردن سفارش یک عملیات نهایی است و ممکن است پیامدهایی برای درخواست مشتری مرتبط داشته باشد.
                                </p>
                            </div>
                        )}
                        {newStatus === 'تحویل مشتری شد' && (
                            <div className="bg-green-50 dark:bg-green-900/20 border-r-4 border-green-500 p-4 rounded-md">
                                <p className="text-sm text-green-700 dark:text-green-300">
                                    توجه: با تکمیل کردن این سفارش، مراحل بعدی برای تسویه حساب با تامین کننده فعال خواهد شد.
                                </p>
                            </div>
                        )}
                        <div className="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button onClick={onCancel} disabled={isUpdating} className="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">انصراف</button>
                            <button onClick={onConfirm} disabled={isUpdating} className="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white shadow-md disabled:opacity-50 flex items-center gap-2">
                                {isUpdating && <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>}
                                {isUpdating ? 'در حال بروزرسانی...' : 'بله، تغییر بده'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };


        const PurchaseOrderManagement = () => {
            const [allPurchaseOrders, setAllPurchaseOrders] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const [viewingPO, setViewingPO] = React.useState(null);
            const [editingPO, setEditingPO] = React.useState(null);
            const [printingPO, setPrintingPO] = React.useState(null);
            const [statusFilter, setStatusFilter] = React.useState('All');
            const [searchTerm, setSearchTerm] = React.useState('');
            const [startDate, setStartDate] = React.useState('');
            const [endDate, setEndDate] = React.useState('');
            const [hideCancelled, setHideCancelled] = React.useState(true); // Default to true
            const [customerBalances, setCustomerBalances] = React.useState({}); // New State for Balances

            const [selectedPOs, setSelectedPOs] = React.useState(new Set());
            const [showMergeConfirm, setShowMergeConfirm] = React.useState(false);
            const [isMerging, setIsMerging] = React.useState(false);
            const [statusUpdateInfo, setStatusUpdateInfo] = React.useState(null); 
            const [isUpdatingStatus, setIsUpdatingStatus] = React.useState(false);
            const [sortConfig, setSortConfig] = React.useState({ key: 'created_at', direction: 'descending' });
            const showToast = useToast();

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            const getSortIcon = (name) => {
                if (sortConfig.key !== name) {
                    return null;
                }
                return sortConfig.direction === 'ascending' ? '▲' : '▼';
            };

            // Fetch balances for specific users
            const fetchBalancesForUsers = async (userIds) => {
                const uniqueIds = [...new Set(userIds)];
                const missingIds = uniqueIds.filter(id => customerBalances[id] === undefined);
                if (missingIds.length === 0) return;

                const newBalances = {};
                await Promise.all(missingIds.map(async (uid) => {
                    const balance = await fetchUserBalance(uid);
                    newBalances[uid] = balance;
                }));
                setCustomerBalances(prev => ({ ...prev, ...newBalances }));
            };

            const fetchData = React.useCallback(async () => {
                setIsLoading(true);
                setError('');
                
                const fetchWithRetry = async (fn, retries = 3, delay = 1000) => {
                    try {
                        return await fn();
                    } catch (err) {
                        if (retries === 0) throw err;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(fn, retries - 1, delay * 2);
                    }
                };

                try {
                    await fetchWithRetry(async () => {
                        let poQuery = supabaseClient
                            .from('purchase_orders')
                            .select(`
                                id, created_at, status, demandid, demandinvoice_id, actual_shipping_cost, supplier_id,
                                supplier:supplier_id(fullname, mobile, location:locationid(postalcode, address, plaque)),
                                purchase_order_details(
                                    id, quantity, purchase_price, actual_shipping_price, demand_item_id,
                                    demand_item:demand_item_id(
                                        product:productid(title),
                                        demandstatusid,
                                        quantity,
                                        demandinvoicedetail:demandinvoicedetail(id, demandinvoiceid, shippingprice, quantity)
                                    )
                                )
                            `);

                        const { data: pos, error: poError } = await poQuery.order('created_at', { ascending: false });

                        if (poError) throw poError;
                        
                        if (!pos || pos.length === 0) {
                            setAllPurchaseOrders([]); 
                            // If we return here, we stop the loader in finally block
                            return; 
                        }

                        const demandIds = [...new Set(pos.map(po => po.demandid).filter(Boolean))];

                        // Fetch customer info even if no demand items (edge case)
                        let customersMap = new Map();

                        if (demandIds.length > 0) {
                             // 1. Fetch Demands
                             const { data: demands, error: demandError } = await supabaseClient
                                 .from('demand')
                                 .select('id, customeruserid') 
                                 .in('id', demandIds);
                            
                             if (demandError) throw demandError;

                             // 2. Fetch Customers
                             const customerIds = [...new Set(demands.map(d => d.customeruserid).filter(Boolean))];
                             if(customerIds.length > 0) {
                                 const { data: customers, error: customerError } = await supabaseClient
                                     .from('profiles')
                                     .select('id, fullname')
                                     .in('id', customerIds);
                                
                                 if (customerError) throw customerError;
                                 const profileMap = new Map(customers.map(c => [c.id, c]));
                                
                                 demands.forEach(d => {
                                     customersMap.set(d.id, { 
                                         ...d, 
                                         customer: profileMap.get(d.customeruserid) 
                                     });
                                 });
                             }
                        }

                        // 1. Fetch all possible demand status types
                        const { data: statusTypes, error: statusTypesError } = await supabaseClient
                            .from('demandstatustype')
                            .select('id, main_status');

                        if (statusTypesError) throw statusTypesError;

                        // 2. Create a lookup map for status types (id -> main_status string)
                        const statusTypeMap = new Map(statusTypes.map(st => [st.id, st.main_status]));

                        const processedData = pos.map(po => {
                            let subtotal = 0;
                            let totalCustomerShipping = 0;
                            let invoiceIds = new Set();

                            // Process details to sum up shipping cost from demandinvoicedetail table
                            const enrichedDetails = po.purchase_order_details.map(detail => {
                                // Handle relationship to demandinvoicedetail
                                const invDetailData = detail.demand_item?.demandinvoicedetail;
                                const invDetail = Array.isArray(invDetailData) ? invDetailData[0] : invDetailData;

                                const shippingPrice = invDetail?.shippingprice || 0;
                                const invId = invDetail?.demandinvoiceid;
                                const invDetailId = invDetail?.id;
                                
                                // === LOGIC UPDATE ===
                                // 1. Customer Requested Qty: Strictly from Demand Item table
                                const customerRequestedQty = detail.demand_item?.quantity || 0;

                                // 2. Purchase Qty (The quantity used in PO): Prefer Demand Invoice Detail quantity if valid
                                // If invDetail.quantity is null or undefined, fallback to the stored PO detail quantity
                                const purchaseQty = (invDetail && typeof invDetail.quantity === 'number') 
                                    ? invDetail.quantity 
                                    : detail.quantity;

                                const lineTotal = purchaseQty * detail.purchase_price;
                                subtotal += lineTotal;

                                if (invId) invoiceIds.add(invId);
                                totalCustomerShipping += shippingPrice;

                                return {
                                    ...detail,
                                    quantity: purchaseQty, // Use the determined Purchase Quantity
                                    invDetailId, 
                                    invDetailShipping: shippingPrice,
                                    invId,
                                    customerRequestedQty 
                                };
                            });
                            
                            // Get base customer info from the map
                            const demandInfo = customersMap.get(po.demandid);
                            const realInvoiceId = invoiceIds.size > 0 ? Array.from(invoiceIds).join(', ') : null;
                            
                            // --- Status Logic ---
                            const firstDetail = po.purchase_order_details?.[0];
                            const statusId = firstDetail?.demand_item?.demandstatusid;
                            const statusString = statusTypeMap.get(statusId) || '---';

                            return {
                                ...po,
                                purchase_order_details: enrichedDetails, // Use the enriched details
                                status: po.status ? po.status.trim() : 'باید بخرم', 
                                demand: { 
                                    ...demandInfo, 
                                    customeruserid: demandInfo?.customeruserid, // Explicitly keep this for balance lookup
                                    customer: demandInfo?.customer,
                                    status: statusString 
                                },
                                customerShippingCost: totalCustomerShipping, 
                                realInvoiceId: realInvoiceId, 
                                subtotal,
                                totalAmount: subtotal 
                            };
                        });
                        
                        setAllPurchaseOrders(processedData); 

                        // Fetch Balances for all loaded POs
                        const allCustomerIds = processedData
                            .map(po => po.demand?.customeruserid)
                            .filter(Boolean);
                        
                        if (allCustomerIds.length > 0) {
                            fetchBalancesForUsers(allCustomerIds);
                        }
                    });

                } catch (err) {
                    console.error("Error fetching purchase orders:", err);
                    let msg = err.message;
                    if (msg === 'Failed to fetch') {
                        msg = 'خطا در برقراری ارتباط با سرور. لطفا اتصال اینترنت خود را بررسی کنید یا دقایقی دیگر تلاش کنید.';
                    }
                    setError(`خطا در بارگذاری اطلاعات: ${msg}`);
                } finally {
                    setIsLoading(false);
                }
            }, []); 
            
            React.useEffect(() => {
                fetchData();
            }, [fetchData]);

            const summaryData = React.useMemo(() => {
                const counts = {
                    'باید بخرم': 0,
                    'خریداری شد': 0,
                    'تحویل بازوی ارسال شد': 0,
                    'تحویل مشتری شد': 0,
                    'محاسبه سود و زیان انجام شد': 0,
                    'Cancelled': 0,
                    'Merged': 0,
                };
                for (const po of allPurchaseOrders) {
                    if (counts.hasOwnProperty(po.status)) {
                        counts[po.status]++;
                    }
                }
                return counts;
            }, [allPurchaseOrders]);

            // Memoized list after status, date, and Cancelled filter
            const filteredPOs = React.useMemo(() => {
                let items = [...allPurchaseOrders];

                // Filter for cancelled demands
                if (hideCancelled) {
                    items = items.filter(po => po.demand?.status !== 'Cancelled');
                }

                // Status Filter
                if (statusFilter !== 'All') {
                    items = items.filter(po => po.status === statusFilter);
                }

                // Date Range Filter
                const start = startDate ? new Date(startDate) : null;
                const end = endDate ? new Date(endDate) : null;
                
                if (start) start.setHours(0, 0, 0, 0); 
                if (end) end.setHours(23, 59, 59, 999);

                if (start || end) {
                    items = items.filter(po => {
                        const poDate = new Date(po.created_at);
                        const afterStart = !start || poDate >= start;
                        const beforeEnd = !end || poDate <= end;
                        return afterStart && beforeEnd;
                    });
                }
                
                return items;
            }, [allPurchaseOrders, statusFilter, startDate, endDate, hideCancelled]);

            const mergeInfo = React.useMemo(() => {
                if (selectedPOs.size < 2) return { possible: false };
                const posToMerge = allPurchaseOrders.filter(po => selectedPOs.has(po.id));
                if (posToMerge.length !== selectedPOs.size) return { possible: false };

                const firstSupplierId = posToMerge[0]?.supplier_id;
                const isSameSupplier = posToMerge.every(po => po.supplier_id === firstSupplierId);
                const allPending = posToMerge.every(po => po.status === 'باید بخرم');

                if (isSameSupplier && allPending) {
                    return {
                        possible: true,
                        supplierId: firstSupplierId,
                        supplierName: posToMerge[0]?.supplier?.fullname,
                        count: posToMerge.length,
                        poObjects: posToMerge,
                    };
                }
                return { possible: false };
            }, [selectedPOs, allPurchaseOrders]); 

            const handleSelectPO = (poId) => {
                const newSelection = new Set(selectedPOs);
                if (newSelection.has(poId)) {
                    newSelection.delete(poId);
                } else {
                    newSelection.add(poId);
                }
                setSelectedPOs(newSelection);
            };

            const executeStatusUpdate = async () => {
                if (!statusUpdateInfo) return;
                const { poId, newStatus, oldStatus } = statusUpdateInfo;
            
                setIsUpdatingStatus(true);
                // Optimistic update
                setAllPurchaseOrders(prevPOs => prevPOs.map(po => po.id === poId ? { ...po, status: newStatus } : po));
                setStatusUpdateInfo(null); 
            
                const { error: updateError } = await supabaseClient
                    .from('purchase_orders')
                    .update({ status: newStatus })
                    .eq('id', poId);
            
                if (updateError) {
                    console.error("Error updating status:", updateError);
                    // Rollback optimistic update
                    setAllPurchaseOrders(prevPOs => prevPOs.map(po => po.id === poId ? { ...po, status: oldStatus } : po));
                    showToast(`خطا در بروزرسانی وضعیت: ${updateError.message}`, 'error');
                } else {
                    // Log the change
                    await supabaseClient.from('purchase_order_logs').insert({
                        purchase_order_id: poId,
                        previous_status: oldStatus,
                        new_status: newStatus
                    });
                    showToast('وضعیت با موفقیت بروزرسانی شد.');
                }
                setIsUpdatingStatus(false);
            };

            const handleSavePO = async (poId, updatedDetails, actualShippingCost, supplierId) => {
                try {
                    // 1. Update Purchase Order Details (PO price and actual shipping cost to us)
                    const detailUpdatePromises = updatedDetails.map(detail =>
                        supabaseClient
                            .from('purchase_order_details')
                            .update({
                                quantity: parseFormattedNumber(detail.quantity),
                                purchase_price: parseFormattedNumber(detail.purchase_price),
                                actual_shipping_price: parseFormattedNumber(detail.actual_shipping_price)
                            })
                            .eq('id', detail.id)
                    );

                    // 2. Sync ONLY Quantity back to Demand Invoice Detail table (as requested by user)
                    // We explicitly *DO NOT* update 'shippingprice' in demandinvoicedetail.
                    const invoiceDetailUpdatePromises = updatedDetails
                        .filter(detail => detail.invDetailId) 
                        .map(detail => 
                            supabaseClient
                                .from('demandinvoicedetail')
                                .update({
                                    // shippingprice: parseFormattedNumber(detail.actual_shipping_price), <-- REMOVED AS REQUESTED
                                    quantity: parseFormattedNumber(detail.quantity) // Keep syncing Quantity
                                })
                                .eq('id', detail.invDetailId)
                        );

                    // 3. Update the main Purchase Order record (total actual shipping cost and supplier)
                    const poUpdatePromise = supabaseClient
                        .from('purchase_orders')
                        .update({ 
                            actual_shipping_cost: parseFormattedNumber(actualShippingCost),
                            supplier_id: supplierId
                        })
                        .eq('id', poId);

                    const results = await Promise.allSettled([
                        ...detailUpdatePromises, 
                        ...invoiceDetailUpdatePromises,
                        poUpdatePromise
                    ]);
                    
                    const errors = results.filter(res => res.status === 'rejected' || (res.value && res.value.error));
                    if (errors.length > 0) {
                        const firstError = errors.length > 0 ? (errors[0].reason?.message || errors[0].value?.error?.message || 'خطای نامشخص') : '';
                        throw new Error(firstError);
                    }
                    
                    showToast('سفارش خرید با موفقیت بروزرسانی شد.');
                    setEditingPO(null);
                    fetchData(); 
                } catch(err) {
                    console.error("Error saving PO:", err);
                    throw err; 
                }
            };

            const handleConfirmMerge = async () => {
                if (!mergeInfo.possible) {
                    showToast('شرایط لازم برای ادغام سفارشات وجود ندارد.', 'error');
                    return;
                }
                setIsMerging(true);
                try {
                    const mergedItems = new Map();
                    mergeInfo.poObjects.forEach(po => {
                        po.purchase_order_details.forEach(detail => {
                            const key = detail.demand_item_id;
                            const currentQty = parseFormattedNumber(detail.quantity);
                            const currentPrice = parseFormattedNumber(detail.purchase_price);
                            const currentShipping = parseFormattedNumber(detail.actual_shipping_price || 0);

                            if (mergedItems.has(key)) {
                                const existing = mergedItems.get(key);
                                // Simple aggregation (assuming price/shipping must be uniform for mergeable items, or we take the latest/highest)
                                existing.quantity = Number(existing.quantity) + currentQty;
                                // For simplicity and consistency, keep the existing unit price/shipping price.
                                // NOTE: In a real system, average price calculation would be safer if prices differ.
                                // For now, we assume the price/shipping are consistent or we take the latest.
                                mergedItems.set(key, existing);
                            } else {
                                mergedItems.set(key, { 
                                    ...detail, 
                                    quantity: currentQty,
                                    purchase_price: currentPrice,
                                    actual_shipping_price: currentShipping
                                });
                            }
                        });
                    });
                    
                    // 1. Create the new Purchase Order
                    const { data: newPO, error: newPOError } = await supabaseClient
                        .from('purchase_orders')
                        .insert({
                            supplier_id: mergeInfo.supplierId,
                            status: 'باید بخرم',
                            demandid: mergeInfo.poObjects[0].demandid, // Assuming single demand for merged group, using the first one
                            demandinvoice_id: mergeInfo.poObjects[0].demandinvoice_id,
                        })
                        .select()
                        .single();

                    if (newPOError) throw newPOError;

                    // 2. Insert merged details
                    const newDetails = Array.from(mergedItems.values()).map(item => ({
                        purchase_order_id: newPO.id,
                        demand_item_id: item.demand_item_id,
                        quantity: item.quantity,
                        purchase_price: item.purchase_price,
                        actual_shipping_price: item.actual_shipping_price
                    }));

                    const { error: newDetailsError } = await supabaseClient
                        .from('purchase_order_details')
                        .insert(newDetails);
                    
                    if (newDetailsError) {
                        // Attempt to rollback PO creation if detail insertion fails
                        await supabaseClient.from('purchase_orders').delete().eq('id', newPO.id);
                        throw newDetailsError;
                    }

                    // 3. Mark old POs as Merged
                    const oldPoIds = mergeInfo.poObjects.map(po => po.id);
                    const { error: updateOldError } = await supabaseClient
                        .from('purchase_orders')
                        .update({ status: 'Merged' })
                        .in('id', oldPoIds);
                    
                    if (updateOldError) throw updateOldError;

                    // 4. Log changes for all merged POs
                    const logEntries = oldPoIds.map(id => ({
                        purchase_order_id: id,
                        previous_status: 'باید بخرم', // We know they were 'باید بخرم'
                        new_status: 'Merged'
                    }));
                    await supabaseClient.from('purchase_order_logs').insert(logEntries);

                    showToast(`سفارشات با موفقیت در سفارش جدید #${newPO.id} ادغام شدند.`);
                } catch(err) {
                    console.error("Error during merge:", err);
                    showToast(`عملیات ادغام ناموفق بود: ${err.message}`, 'error');
                } finally {
                    setIsMerging(false);
                    setShowMergeConfirm(false);
                    setSelectedPOs(new Set());
                    fetchData(); 
                }
            };
            
            const displayedPOs = React.useMemo(() => {
                let sortableItems = [...filteredPOs];
        
                if (sortConfig.key) {
                    sortableItems.sort((a, b) => {
                        let aValue = a[sortConfig.key];
                        let bValue = b[sortConfig.key];

                        if (sortConfig.key === 'totalAmount') {
                            aValue = a.totalAmount;
                            bValue = b.totalAmount;
                        }

                        if (aValue === null || aValue === undefined) return 1;
                        if (bValue === null || bValue === undefined) return -1;
                        
                        if (sortConfig.key === 'created_at') {
                            const dateA = new Date(aValue);
                            const dateB = new Date(bValue);
                            if (dateA < dateB) return sortConfig.direction === 'ascending' ? -1 : 1;
                            if (dateA > dateB) return sortConfig.direction === 'ascending' ? 1 : -1;
                            return 0;
                        }

                        if (aValue < bValue) {
                            return sortConfig.direction === 'ascending' ? -1 : 1;
                        }
                        if (aValue > bValue) {
                            return sortConfig.direction === 'ascending' ? 1 : -1;
                        }
                        return 0;
                    });
                }

                if (!searchTerm) {
                    return sortableItems;
                }
                
                const lowercasedFilter = searchTerm.toLowerCase();
                return sortableItems.filter(po => 
                    po.id.toString().includes(lowercasedFilter) ||
                    (po.demandid && po.demandid.toString().includes(lowercasedFilter)) ||
                    (po.supplier?.fullname && po.supplier.fullname.toLowerCase().includes(lowercasedFilter)) ||
                    (po.demand?.customer?.fullname && po.demand.customer.fullname.toLowerCase().includes(lowercasedFilter)) ||
                    (po.demand?.status && po.demand.status.toLowerCase().includes(lowercasedFilter)) 
                );
            }, [filteredPOs, searchTerm, sortConfig]); 

            return (
                 <div className="p-4 md:p-8 text-gray-900 dark:text-gray-100 min-h-screen">
                     <header className="mb-8 flex flex-col md:flex-row md:justify-between md:items-end gap-4">
                         <div>
                             <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-l from-indigo-500 to-purple-600">مدیریت سفارشات خرید (PO)</h1>
                             <p className="text-gray-500 dark:text-gray-400 mt-1">سفارشات ارسال شده به تامین کنندگان را پیگیری کنید.</p>
                         </div>
                         <div className="flex gap-2">
                             <button onClick={fetchData} className="p-2 bg-gray-200 dark:bg-gray-700 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="بروزرسانی">
                                 <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                     <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                 </svg>
                             </button>
                         </div>
                     </header>

                     <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                         <div className="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border-r-4 border-yellow-500 dark:border-yellow-400">
                             <div className="text-sm font-medium text-gray-500 dark:text-gray-400">باید بخرم</div>
                             <div className="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{summaryData['باید بخرم'] || 0}</div>
                         </div>
                         <div className="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border-r-4 border-blue-500 dark:border-blue-400">
                             <div className="text-sm font-medium text-gray-500 dark:text-gray-400">خریداری شد</div>
                             <div className="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{summaryData['خریداری شد'] || 0}</div>
                         </div>
                         <div className="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border-r-4 border-purple-500 dark:border-purple-400">
                             <div className="text-sm font-medium text-gray-500 dark:text-gray-400">تحویل بازوی ارسال شد</div>
                             <div className="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{summaryData['تحویل بازوی ارسال شد'] || 0}</div>
                         </div>
                         <div className="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border-r-4 border-green-500 dark:border-green-400">
                             <div className="text-sm font-medium text-gray-500 dark:text-gray-400">تحویل مشتری شد</div>
                             <div className="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{summaryData['تحویل مشتری شد'] || 0}</div>
                         </div>
                         <div className="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border-r-4 border-teal-500 dark:border-teal-400">
                             <div className="text-sm font-medium text-gray-500 dark:text-gray-400">محاسبه سود و زیان</div>
                             <div className="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{summaryData['محاسبه سود و زیان انجام شد'] || 0}</div>
                         </div>
                     </div>

                     <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-8">
                         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                             {/* Row 1: Filters */}
                             <div>
                                 <label htmlFor="status-filter" className="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">فیلتر وضعیت:</label>
                                 <div className="relative">
                                     <select id="status-filter" value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} className="w-full p-2.5 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none appearance-none">
                                         <option value="All">همه وضعیت ها</option>
                                         {PO_STATUSES.map(status => <option key={status} value={status}>{status}</option>)}
                                     </select>
                                     <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                                         <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                     </div>
                                 </div>
                             </div>
                             <div>
                                 <label htmlFor="start-date" className="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">از تاریخ:</label>
                                 <input 
                                     id="start-date" 
                                     type="date" 
                                     value={startDate}
                                     onChange={(e) => setStartDate(e.target.value)}
                                     className="w-full p-2.5 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                 />
                             </div>
                             <div>
                                 <label htmlFor="end-date" className="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">تا تاریخ:</label>
                                 <input 
                                     id="end-date" 
                                     type="date" 
                                     value={endDate}
                                     onChange={(e) => setEndDate(e.target.value)}
                                     className="w-full p-2.5 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                 />
                             </div>
                             <div className="self-end">
                                 <button
                                     onClick={() => { setStartDate(''); setEndDate(''); }}
                                     className="w-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-2.5 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600"
                                 >
                                     پاک کردن تاریخ
                                 </button>
                             </div>

                             {/* Row 2: Search & Merge */}
                             <div className="md:col-span-2">
                                 <label htmlFor="search-filter" className="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">جستجو پیشرفته:</label>
                                 <div className="relative">
                                     <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                         <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                     </div>
                                     <input 
                                         id="search-filter"
                                         type="text"
                                         placeholder="شماره PO، شماره تقاضا، نام تامین کننده، نام مشتری..."
                                         value={searchTerm}
                                         onChange={(e) => setSearchTerm(e.target.value)}
                                         className="w-full p-2.5 pr-10 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none"
                                     />
                                 </div>
                             </div>
                             {/* Checkbox to hide cancelled demands */}
                             <div className="self-end flex items-center justify-start h-[42px] bg-gray-50 dark:bg-gray-700/50 rounded-lg px-4 border border-gray-200 dark:border-gray-700">
                                 <input 
                                     type="checkbox"
                                     id="hide-cancelled"
                                     checked={hideCancelled}
                                     onChange={(e) => setHideCancelled(e.target.checked)}
                                     className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 ml-2"
                                 />
                                 <label htmlFor="hide-cancelled" className="text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer select-none">
                                     مخفی کردن تقاضاهای لغو شده
                                 </label>
                             </div>
                             <div className="self-end">
                                 <button 
                                     onClick={() => setShowMergeConfirm(true)}
                                     disabled={!mergeInfo.possible}
                                     className={`w-full py-2.5 px-4 rounded-lg transition-all shadow-sm flex items-center justify-center gap-2 ${mergeInfo.possible 
                                         ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white transform hover:-translate-y-0.5' 
                                         : 'bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500 cursor-not-allowed'}`}
                                 >
                                     <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                                     ادغام ({selectedPOs.size}) سفارش
                                 </button>
                             </div>
                         </div>
                     </div>

                     {isLoading && <div className="spinner"></div>}
                     {error && <p className="text-center p-8 text-red-500 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-900">{error}</p>}
                     
                     {!isLoading && !error && (
                         <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                             {/* Desktop Table */}
                             <div className="hidden md:block overflow-x-auto">
                                 <table className="w-full text-right">
                                     <thead className="bg-gray-50 dark:bg-gray-900/50 text-gray-500 dark:text-gray-400 text-sm uppercase">
                                         <tr className="border-b dark:border-gray-700">
                                             <th className="p-4 w-12 text-center">
                                                 <svg className="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg>
                                             </th>
                                             <th className="p-4 font-semibold cursor-pointer hover:text-indigo-500 transition-colors" onClick={() => requestSort('id')}>
                                                 <div className="flex items-center gap-1">PO # <span className="text-xs">{getSortIcon('id')}</span></div>
                                             </th>
                                             <th className="p-4 font-semibold cursor-pointer hover:text-indigo-500 transition-colors" onClick={() => requestSort('demandid')}>
                                                 <div className="flex items-center gap-1">تقاضا # <span className="text-xs">{getSortIcon('demandid')}</span></div>
                                             </th>
                                             <th className="p-4 font-semibold text-center">فاکتور #</th>
                                             <th className="p-4 font-semibold">وضعیت تقاضا</th>
                                             <th className="p-4 font-semibold">تامین کننده</th>
                                             <th className="p-4 font-semibold">مشتری</th>
                                             <th className="p-4 font-semibold text-center">مانده حساب مشتری</th>
                                             <th className="p-4 font-semibold cursor-pointer hover:text-indigo-500 transition-colors" onClick={() => requestSort('created_at')}>
                                                 <div className="flex items-center gap-1">تاریخ <span className="text-xs">{getSortIcon('created_at')}</span></div>
                                             </th>
                                             <th className="p-4 font-semibold text-center">هزینه حمل مشتری</th>
                                             <th className="p-4 font-semibold text-center">هزینه حمل واقعی</th>
                                             <th className="p-4 font-semibold cursor-pointer hover:text-indigo-500 transition-colors" onClick={() => requestSort('totalAmount')}>
                                                 <div className="flex items-center gap-1">مبلغ فاکتور تامین کننده <span className="text-xs">{getSortIcon('totalAmount')}</span></div>
                                             </th>
                                             <th className="p-4 font-semibold">وضعیت سفارش</th>
                                             <th className="p-4 font-semibold text-center">عملیات</th>
                                         </tr>
                                     </thead>
                                     <tbody className="divide-y divide-gray-100 dark:divide-gray-700 text-sm">
                                         {displayedPOs.map(po => (
                                             <tr key={po.id} className="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150">
                                                 <td className="p-4 text-center">
                                                     {po.status === 'باید بخرم' && (
                                                         <input 
                                                             type="checkbox" 
                                                             className="rounded w-4 h-4 text-indigo-600 focus:ring-indigo-500 cursor-pointer" 
                                                             checked={selectedPOs.has(po.id)}
                                                             onChange={() => handleSelectPO(po.id)}
                                                         />
                                                     )}
                                                 </td>
                                                 <td className="p-4 font-mono font-medium text-indigo-600 dark:text-indigo-400">{po.id}</td>
                                                 <td className="p-4 font-mono text-gray-500">{po.demandid}</td>
                                                 <td className="p-4 font-mono text-center text-gray-500">{po.realInvoiceId || '-'}</td>
                                                 <td className="p-4">
                                                     <span className={`px-2.5 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${getDemandStatusStyles(po.demand?.status)}`}>
                                                         {po.demand?.status || '---'}
                                                     </span>
                                                 </td>
                                                 <td className="p-4 font-medium">{po.supplier?.fullname || 'نامشخص'}</td>
                                                 <td className="p-4 text-gray-600 dark:text-gray-300">{po.demand?.customer?.fullname || 'نامشخص'}</td>
                                                 <td className={`p-4 font-semibold text-center ${customerBalances[po.demand?.customeruserid] < 0 ? 'text-red-500' : 'text-green-500'}`}>
                                                     {customerBalances[po.demand?.customeruserid] !== undefined ? `${formatCurrency(customerBalances[po.demand?.customeruserid])} تومان` : '...'}
                                                 </td>
                                                 <td className="p-4 text-gray-500">{new Date(po.created_at).toLocaleDateString('fa-IR')}</td>
                                                 <td className="p-4 font-mono text-center text-gray-600 dark:text-gray-400">{formatCurrency(po.customerShippingCost)}</td>
                                                 <td className="p-4 font-mono text-center text-gray-600 dark:text-gray-400">{formatCurrency(po.actual_shipping_cost || 0)}</td>
                                                 <td className="p-4 font-bold text-gray-800 dark:text-gray-200">{formatCurrency(po.totalAmount)}</td>
                                                 <td className="p-4">
                                                     <select
                                                         value={po.status}
                                                         onChange={(e) => {
                                                             if (e.target.value !== po.status) {
                                                                 setStatusUpdateInfo({ poId: po.id, newStatus: e.target.value, oldStatus: po.status });
                                                             }
                                                         }}
                                                         className={`rounded-lg p-1.5 text-xs font-semibold w-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-offset-white dark:focus:ring-offset-gray-800 ${getStatusStyles(po.status)}`}
                                                     >
                                                         {PO_STATUSES.map(status => <option key={status} value={status}>{status}</option>)}
                                                     </select>
                                                 </td>
                                                 <td className="p-4">
                                                     <div className="flex items-center justify-center gap-2">
                                                        <button onClick={() => setEditingPO(po)} className="text-yellow-600 dark:text-yellow-500 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 p-1.5 rounded-lg transition-colors" title="ویرایش">
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                                        </button>
                                                         <button onClick={() => setViewingPO(po)} className="text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 p-1.5 rounded-lg transition-colors" title="جزئیات">
                                                             <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                                         </button>
                                                         <button onClick={() => setPrintingPO(po)} className="text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 p-1.5 rounded-lg transition-colors" title="چاپ">
                                                             <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                                         </button>
                                                     </div>
                                                 </td>
                                             </tr>
                                         ))}
                                     </tbody>
                                 </table>
                             </div>
                             {/* Mobile Card View */}
                             <div className="md:hidden p-4 space-y-4 bg-gray-50 dark:bg-gray-900/20">
                                  {displayedPOs.map(po => (
                                      <div key={po.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border border-gray-100 dark:border-gray-700">
                                          <div className="flex justify-between items-start mb-3 pb-3 border-b border-dashed border-gray-200 dark:border-gray-700">
                                              <div className="flex items-start gap-3">
                                                  {po.status === 'باید بخرم' && (
                                                      <input 
                                                          type="checkbox" 
                                                          className="rounded h-5 w-5 mt-1 text-indigo-600"
                                                          checked={selectedPOs.has(po.id)}
                                                          onChange={() => handleSelectPO(po.id)}
                                                      />
                                                   )}
                                                   <div>
                                                       <div className="flex items-center gap-2">
                                                            <span className="text-xs font-bold bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-600 dark:text-gray-300">PO #{po.id}</span>
                                                            <span className="text-xs text-gray-400">{new Date(po.created_at).toLocaleDateString('fa-IR')}</span>
                                                       </div>
                                                       <p className="font-bold text-gray-900 dark:text-white mt-1">{po.supplier?.fullname || 'نامشخص'}</p>
                                                       <p className="text-sm text-gray-600 dark:text-gray-400 mt-0.5">{po.demand?.customer?.fullname || 'مشتری نامشخص'}</p>
                                                        <p className={`text-sm mt-1 font-semibold ${customerBalances[po.demand?.customeruserid] < 0 ? 'text-red-500' : 'text-green-500'}`}>
                                                            مانده حساب: {customerBalances[po.demand?.customeruserid] !== undefined ? `${formatCurrency(customerBalances[po.demand?.customeruserid])} تومان` : '...'}
                                                        </p>
                                                        
                                                        <div className="flex flex-wrap items-center gap-2 mt-2">
                                                            <span className="text-xs text-gray-500">تقاضا: {po.demandid}</span>
                                                            {po.realInvoiceId && <span className="text-xs text-gray-500">فاکتور: {po.realInvoiceId}</span>}
                                                            <span className={`px-2 py-0.5 text-[10px] font-semibold rounded-full whitespace-nowrap ${getDemandStatusStyles(po.demand?.status)}`}>
                                                                {po.demand?.status || '---'}
                                                            </span>
                                                        </div>
                                                   </div>
                                              </div>
                                          </div>
                                          
                                          <div className="mb-4 space-y-2">
                                              <div className="flex justify-between items-center text-sm">
                                                  <span className="text-gray-500 dark:text-gray-400">جمع محصولات:</span>
                                                  <span className="font-medium">{formatCurrency(po.subtotal)}</span>
                                              </div>
                                              <div className="flex justify-between items-center text-sm">
                                                  <span className="text-gray-500 dark:text-gray-400">هزینه حمل مشتری:</span>
                                                  <span className="font-medium">{formatCurrency(po.customerShippingCost)}</span>
                                              </div>
                                              <div className="flex justify-between items-center text-sm">
                                                  <span className="text-gray-500 dark:text-gray-400">هزینه حمل واقعی:</span>
                                                  <span className="font-medium">{formatCurrency(po.actual_shipping_cost || 0)}</span>
                                              </div>
                                              <div className="flex justify-between items-center pt-2 border-t border-gray-100 dark:border-gray-700">
                                                  <span className="text-sm font-bold text-gray-700 dark:text-gray-200">مبلغ کل:</span>
                                                  <span className="font-bold text-lg text-indigo-600 dark:text-indigo-400">{formatCurrency(po.totalAmount)} تومان</span>
                                              </div>
                                          </div>

                                          <div className="space-y-3">
                                              <select
                                                  value={po.status}
                                                  onChange={(e) => {
                                                      if (e.target.value !== po.status) {
                                                          setStatusUpdateInfo({ poId: po.id, newStatus: e.target.value, oldStatus: po.status });
                                                      }
                                                  }}
                                                  className={`w-full rounded-lg p-2 text-sm font-semibold border-0 ${getStatusStyles(po.status)}`}
                                              >
                                                  {PO_STATUSES.map(status => <option key={status} value={status}>{status}</option>)}
                                              </select>
                                              
                                              <div className="grid grid-cols-3 gap-2">
                                                  <button onClick={() => setEditingPO(po)} className="flex items-center justify-center gap-1 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-400 py-2 rounded-lg text-sm font-medium">
                                                      <span>ویرایش</span>
                                                  </button>
                                                  <button onClick={() => setViewingPO(po)} className="flex items-center justify-center gap-1 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-400 py-2 rounded-lg text-sm font-medium">
                                                      <span>جزئیات</span>
                                                  </button>
                                                  <button onClick={() => setPrintingPO(po)} className="flex items-center justify-center gap-1 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 py-2 rounded-lg text-sm font-medium">
                                                      <span>چاپ</span>
                                                  </button>
                                              </div>
                                          </div>
                                      </div>
                                  ))}
                             </div>
                             {displayedPOs.length === 0 && (
                                 <div className="text-center py-16 px-4">
                                     <div className="bg-gray-100 dark:bg-gray-700 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
                                         <svg className="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                         </svg>
                                     </div>
                                     <h3 className="text-lg font-bold text-gray-900 dark:text-white">هیچ سفارشی یافت نشد</h3>
                                     <p className="mt-2 text-gray-500 dark:text-gray-400 max-w-sm mx-auto">با تغییر فیلترها یا عبارت جستجو دوباره امتحان کنید، یا اینکه هیچ سفارشی با این مشخصات ثبت نشده است.</p>
                                     <button onClick={() => {setSearchTerm(''); setStatusFilter('All'); setStartDate(''); setEndDate('');}} className="mt-6 text-indigo-600 dark:text-indigo-400 font-medium hover:underline">
                                         پاک کردن تمام فیلترها
                                     </button>
                                 </div>
                             )}
                         </div>
                     )}
                        {viewingPO && <ViewPOModal po={viewingPO} onClose={() => setViewingPO(null)} customerBalance={customerBalances[viewingPO?.demand?.customeruserid]} />}
                        {editingPO && <EditPOModal po={editingPO} onClose={() => setEditingPO(null)} onSave={handleSavePO} customerBalance={customerBalances[editingPO?.demand?.customeruserid]} />}
                        {printingPO && <PrintablePOModal po={printingPO} onClose={() => setPrintingPO(null)} />}
                        {showMergeConfirm && <MergeConfirmationModal mergeInfo={mergeInfo} onCancel={() => setShowMergeConfirm(false)} onConfirm={handleConfirmMerge} isMerging={isMerging} />}
                        <StatusConfirmationModal updateInfo={statusUpdateInfo} onCancel={() => setStatusUpdateInfo(null)} onConfirm={executeStatusUpdate} isUpdating={isUpdatingStatus} />
                 </div>
            );
        };

        const App = () => <PurchaseOrderManagement />;

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(
            <ToastProvider>
                <App />
            </ToastProvider>
        );
    </script>
</body>
</html>